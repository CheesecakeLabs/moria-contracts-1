{"version":3,"sources":["../../app/javascripts/api.js"],"names":["console","log","__dirname","web3","providers","HttpProvider","MoriaToken","setProvider","currentProvider","fixTruffleContractCompatibilityIssue","contract","sendAsync","send","apply","arguments","accounts","account","setAccounts","eth","getAccounts","err","accs","length","isAddress","address","test","isChecksumAddress","replace","addressHash","sha3","toLowerCase","i","parseInt","toUpperCase","module","exports","init","getBalance","token","decimals","deployed","then","instance","value","balance","balanceOf","call","from","Math","pow","catch","e","getTotalTokens","total","totalSupply","getOutstandingDividends","outstandingFor","payOutstandingDividends","callback","gasCost","claimDividendsFor","gas","mintTokens","amount","rawAmount","mint","dividendHistory","period","dividends","_period","dividendHistoryFor","_dividends","payDividend","payIn"],"mappings":"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","file":"api.js","sourcesContent":["import { default as Web3} from 'web3';\n\nimport { default as contract } from 'truffle-contract'\n\nconsole.log(__dirname);\nimport MoriaTokenSol from '../../build/contracts/MoriaToken.json'\n\n// needs to get env\nvar web3 = new Web3(new Web3.providers.HttpProvider(\"http://devnet:8545\"));\nvar MoriaToken = contract(MoriaTokenSol);\nMoriaToken.setProvider(web3.currentProvider);\nfixTruffleContractCompatibilityIssue(MoriaToken);\n\n// Workaround for a compatibility issue between web3@1.0.0-beta.29 and truffle-contract@3.0.3\n// https://github.com/trufflesuite/truffle-contract/issues/57#issuecomment-331300494\nfunction fixTruffleContractCompatibilityIssue(contract) {\n    if (typeof contract.currentProvider.sendAsync !== \"function\") {\n        contract.currentProvider.sendAsync = function() {\n            return contract.currentProvider.send.apply(\n                contract.currentProvider, arguments\n            );\n        };\n    }\n    return contract;\n}\n\nvar accounts;\nvar account;\n\nvar setAccounts = function() {\n  web3.eth.getAccounts(function(err, accs) {\n    if (err != null) {\n      console.log(\"There was an error fetching your accounts.\" + err);\n      return;\n    }\n    \n    if (accs.length == 0) {\n      console.log(\"Couldn't get any accounts! Make sure your Ethereum client is configured correctly.\");\n      return;\n    }\n    \n    accounts = accs;\n    account = accounts[0]; \n  });\n}\n\nvar isAddress = function(address) {\n  if (!/^(0x)?[0-9a-f]{40}$/i.test(address)) {\n    // check if it has the basic requirements of an address\n    return false;\n  } else if (/^(0x)?[0-9a-f]{40}$/.test(address) || /^(0x)?[0-9A-F]{40}$/.test(address)) {\n    // If it's all small caps or all all caps, return true\n    return true;\n  } else {\n    // Otherwise check each case\n    return isChecksumAddress(address);\n  }\n}\n\nvar isChecksumAddress = function(address) {\n  // Check each case\n  address = address.replace('0x','');\n  var addressHash = sha3(address.toLowerCase());\n  for (var i = 0; i < 40; i++ ) {\n    // the nth letter should be uppercase if the nth digit of casemap is 1\n    if ((parseInt(addressHash[i], 16) > 7 && address[i].toUpperCase() !== address[i]) || (parseInt(addressHash[i], 16) <= 7 && address[i].toLowerCase() !== address[i])) {\n      return false;\n    }\n  }\n  return true;\n}\n\nmodule.exports = {\n\n  init : function() {\n    setAccounts();\n  },\n\n  getBalance : function(address) {\n    \n    var token;\n    var decimals;\n\n    return MoriaToken.deployed().then(function(instance) {\n      token = instance;\n      return token.decimals();\n    }).then(function(value) {\n      decimals = value;\n      var balance = token.balanceOf.call(address, {from: account});\n      return balance;\n    }).then(function(value) {\n      return value / Math.pow(10, decimals);\n    }).catch(function(e) {\n      console.log(e);\n      return -1;\n    });   \n  },\n\n  getTotalTokens : function() {\n    var token;\n    var decimals;\n    return MoriaToken.deployed().then(function(instance) {\n      token = instance;\n      return token.decimals();\n    }).then(function(value) {\n      decimals = value;\n      console.log(\"decs = \" + decimals);\n      var total = token.totalSupply.call({from: account});\n      return total;\n    }).then(function (value) {\n      return value / Math.pow(10, decimals);\n    }).catch(function(e) {\n      console.log(e);\n      return -1;\n    });\n  },\n\n  getOutstandingDividends : function(address) {\n    return MoriaToken.deployed().then(function(instance) {\n      return instance.outstandingFor.call(address, {from: account})\n    })\n  },\n\n  payOutstandingDividends : function(address, callback) {\n    console.log(\"paying dividends for \" + address);\n    var token;\n\n    return MoriaToken.deployed().then(function(instance) {\n      token = instance;\n      //console.log(web3.eth.getBalance(instance.address).toString());\n      return 150000;//token.claimDividendsFor.estimateGas(address, {from: account});\n    }).then(function(gasCost) {\n      console.log(\"gas cost = \" + gasCost);\n      return token.claimDividendsFor(address, {from: account, gas: gasCost});\n    }).then(function(value) {\n      callback(value);\n      return value;\n    })\n  },\n\n  mintTokens : function(address, amount, callback) {\n    var token;\n    var decimals;\n    return MoriaToken.deployed().then(function(instance) {\n      token = instance;\n      return token.decimals();\n    }).then(function(value) {\n      decimals = value;\n      var rawAmount = amount * Math.pow(10, decimals);\n      return token.mint(address, rawAmount, {from: account})\n    }).then(function(value) {\n      callback(value);\n      return value;\n    });    \n  },\n\n  dividendHistory : function(address) {\n    var token;\n    var period;\n    var dividends;\n\n    return MoriaToken.deployed().then(function(instance) {\n      token = instance;\n      return token.period();\n    }).then(function(_period) {\n      period = _period;\n      console.log('history to period: ' + period);\n      return token.dividendHistoryFor.call(address, {from: account});\n    }).then(function(_dividends) {\n      dividends = _dividends;\n      console.log(dividends);\n      return dividends;\n    });\n  },\n\n  payDividend : function(amount) {\n    var token;\n\n    return MoriaToken.deployed().then(function(instance) {\n      token = instance;\n      return token.payIn({from: account, value: amount});\n    });\n  }\n}\n"]}